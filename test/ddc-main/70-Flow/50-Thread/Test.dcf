module Test with
letrec {
  filter : [k0 : Rate].[a : Data].(a -> Bool#) -> (a -> Bool#) -> Series# k0 a -> Vector# a
    = /\(k0 : Rate)./\(a : Data).
       \(f g : a -> Bool#).\(s0 : Series# k0 a).
      let k1__count : Ref# Nat# = new# [Nat#] 0# in
      let k2__count : Ref# Nat# = new# [Nat#] 0# in
      let x4 : Vector# a = newVectorR# [a] [k0] in
      let _ : Unit
            = loop# [k0]
                  (\(^ : Nat#).
                   let s0__elem : a = next# [a] [k0] s0 ^0 in
                   let x1__elem : Bool#
                         = (\(x : a). f x) s0__elem in
                   let _ : Unit
                         = guard# [k0] k1__count x1__elem
                               (/\(k1 : Rate).
                                 \(^ : Nat#).
                                let x3__elem : Bool#
                                      = (\(x : a). g x) s0__elem in
                                let _ : Unit
                                      = guard# [k1] k2__count x3__elem
                                            (/\(k2 : Rate).
                                              \(^ : Nat#).
                                             let _ : Unit = writeVector# [a] x4 ^0 s0__elem in
                                             ()) in
                                ()) in
                   ()) in
      let x6 : Vector# a = x4 in
      let x8 : Vector# a = x6 in
      x8
}
