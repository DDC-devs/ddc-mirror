:set +Indent +SuppressImports
:set builder x86_64-darwin

    
-- Observable optimisations
-- Feed the output of this test to `opt -S -tbaa -basicaa -gvn -o - <test.ll>`
-- 
--    This test is equivalent to:
--      int gvn_test (int* x, int* y, int* z, int* beta) {
--        int a = *x + *y;
--        *z = a;
--        *beta = *x + *y;
--        return *beta;
--      }
--    Where we have (distinct x z) and (distinct y z)
--    The second load to x and y (to evaluate *x + *y) should be eliminated.
--
-- PROBLEM: since only load/stores can be annotated (and not function calls),
--    we have to inline addInt manually here.
--
:set lang Salt
:to-llvm..
module Test with letrec {

foo [rx ry rz rbeta : %]
    <w1 : Distinct rx rz> <w2 : Distinct ry rz>
    (x : Ptr# rx Int#) 
    (y : Ptr# ry Int#) 
    (z : Ptr# rz Int#)
    (beta : Ptr# rbeta Int#)
    : Void#
 = do  { xval1 = peek# [rx] [Int#] x 0#;
         yval1 = peek# [ry] [Int#] y 0#;
         a     = add# [Int#] xval1 yval1; 
                 poke# [rz] [Int#] z 0# a;
         xval2 = peek# [rx] [Int#] x 0#;
         yval2 = peek# [ry] [Int#] y 0#;
         b     = add# [Int#] xval2 yval2; 
                 poke# [rbeta]  [Int#] beta 0# b; };
};;


-- Include elaborated witnesses in metadata tree
:set lang Lite
:to-llvm..
module Test with letrec

bar (_ : Unit) : Unit
 = letregion r1 in
   letregions r2 r3 with { w1 : Distinct r1 r2 } in ();;
