
-- Convert a Core Salt module into raw C code.
:set lang Salt
:set +Indent
:to-c..
module Main 
imports {
        allocRaw :: Tag# -> Nat# -> Ptr# Obj;
        getTag   :: Ptr# Obj -> Tag#;
}
with letrec {
addInt (x : Ptr# Obj) (y : Ptr# Obj) : Ptr# Obj
 =      let x'  = unboxInt x in
        let y'  = unboxInt y in
        let r   = add# [Int#] x' y' in
        let z   = boxInt r in
        return# [Ptr# Obj] z;

boxInt (x : Int#) : Ptr# Obj
 = do { obj     = allocRaw TAG0# 4#;
        addr    = takePtr# [Obj] obj;
        write#  [Int#] addr 8# x;
        return# [Ptr# Obj] obj;
      };

unboxInt (obj : Ptr# Obj) : Int#
 = do { addr    = takePtr# [Obj] obj;
        x       = read#   [Int#] addr 8#;
        return# [Int#] x;
      };


main (argc : Nat#) (argv : Ptr# String#) : Int#
 =      let x   : Ptr# Obj   = boxInt 5i# in
        let x2  : Ptr# Obj   = addInt x x in
        let str : String#    = showInt# (unboxInt x2) in
        let _   : Void#      = putStrLn# str in
        return# [Int#] 0i#;
};;
