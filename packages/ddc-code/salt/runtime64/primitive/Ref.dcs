
-- | References to boxed values.
module Runtime.Prim.Ref
export value
 allocRef       : [r1 r2 : Region]. Ptr# r1 Obj -> Ptr# r2 Obj
 readRef        : [r1 r2 : Region]. Ptr# r1 Obj -> Ptr# r2 Obj
 writeRef_      : [r1 r2 : Region]. Ptr# r1 Obj -> Ptr# r2 Obj -> Void#

import value
 ddcAllocBoxed  : [r1    : Region]. Tag# -> Nat# -> Ptr# r1 Obj
 ddcGetBoxed    : [r1 r2 : Region]. Ptr# r1 Obj  -> Nat# -> Ptr# r2 Obj
 ddcSetBoxed    : [r1 r2 : Region]. Ptr# r1 Obj  -> Nat# -> Ptr# r2 Obj -> Void#

with letrec


-- | Allocate a new reference to some boxed value.
allocRef [r1 r2: Region] (val: Ptr# r1 Obj): Ptr# r2 Obj
 = do   ref     = ddcAllocBoxed [r2] (truncate# 0#) 1#
        ddcSetBoxed ref 0# val
        ref

-- | Read the value from a reference.
readRef  [r1 r2: Region] (ref: Ptr# r1 Obj): Ptr# r2 Obj
 =      ddcGetBoxed ref 0#


-- | Write a value into reference.
writeRef_ [r1 r2: Region] (ref: Ptr# r1 Obj) (val: Ptr# r2 Obj): Void#
 =      ddcSetBoxed ref 0# val




