
module Lambda.Simple.Core.Eval
export 
{       lift; subst;
        reduce_cbn;
        reduce_no
}
import Lambda.Simple.Core.Exp
where


-- | Lift references to the given name.
lift    (n:  Name)      -- ^ Name of variable to lift references to.
        (d:  Nat)       -- ^ Current binding depth in the expression.
        (xx: Exp p)     -- ^ Expression to lift references in.
        : Exp p
 = case xx of
        XVar  n1 ix
         | n == n1
         , d <= ix      -> XVar n1 (ix + 1)

         | otherwise    -> xx

        XAbs n1 x2
         | n == n1      -> XAbs n1 (lift n (d + 1) x2)
         | otherwise    -> XAbs n1 (lift n  d      x2)

        XApp x1 x2      -> XApp (lift n d x1) (lift n d x2)

        XMacro _        -> xx

        XPrim _         -> xx


-- | Substitute a name for an expression in an expression.
subst   (n:  Name)      -- ^ Name of variable to lift references ot.
        (d:  Nat)       -- ^ Depth of name to substitute for.
        (x:  Exp p)     -- ^ Expression to substitute.
        (xx: Exp p)     -- ^ Expression to substitute into.
        : Exp p
 = case xx of
        XVar n1 ix   
         | n  == n1
         , ix == d      -> x

         | n == n1
         , ix >  d      -> XVar n1 (ix - 1)

         | otherwise    -> xx

        XAbs n1 x2
         | n == n1      -> XAbs n1 (subst n (d + 1) (lift n1 0 x) x2)
         | otherwise    -> XAbs n1 (subst n  d      (lift n1 0 x) x2)

        XApp x1 x2      -> XApp    (subst n d x x1) (subst n d x  x2)

        XMacro _        -> xx

        XPrim _         -> xx


-- | Unfold a macro declaration.
unfold (decls: List (Decl p)) (xx: Exp p): Exp p
 = case xx of
        XMacro n        -> fromMaybe xx (lookupDecl n decls)
        _               -> xx


-- | Call-by-name reduction.
reduce_cbn 
        (decls: List (Decl p))  -- ^ External declarations.
        (xx:    Exp p)          -- ^ Expression to reduce.
        : Maybe (Exp p)
 = case unfold decls xx of
        XVar  _ _       -> Just xx
        XAbs  _ _       -> Just xx

        XApp x1 x2
         |  Just x1'    <- reduce_cbn decls x1
         -> case unfold decls x1' of
                XAbs n11 x12    -> reduce_cbn decls (subst n11 0 x2 x12)
                _               -> Just (XApp x1' x2)

         | otherwise    -> Just xx

        XMacro _        -> Just xx
        XPrim _         -> Just xx


-- | Normal-order reduction.
reduce_no 
        (decls: List (Decl p))  -- ^ External declarations.
        (xx: Exp p)             -- ^ Expression to reduce.
        : Maybe (Exp p)
 = case unfold decls xx of
        XVar  _ _        -> Just xx

        XAbs  n1 x2
         -> case reduce_no decls x2 of
                Just x2' -> Just (XAbs n1 x2')
                Nothing  -> Just xx

        XApp  x1 x2
         |  Just x1'    <- reduce_cbn decls x1 
         -> case unfold decls x1' of
                XAbs n11 x12    -> reduce_no decls (subst n11 0 x2 x12)

                _ |  Just x1''  <- reduce_no decls x1'
                  ,  Just x2'   <- reduce_no decls x2
                  -> Just (XApp x1'' x2')

         | otherwise    -> Just xx

        XMacro _        -> Just xx
        XPrim _         -> Just xx

